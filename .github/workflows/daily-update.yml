name: Daily Constitutional Risk Update

on:
  schedule:
    - cron: "20 12 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: constitutional-risk-pages
  cancel-in-progress: false

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run daily pipeline
        run: python scripts/run_daily.py

      - name: Commit updated artifacts
        run: |
          if [[ -n "$(git status --porcelain data outputs site)" ]]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add data outputs site
            git commit -m "Daily constitutional risk update ($(date -u +%F))"
            git push
          else
            echo "No artifact changes."
          fi

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Read dashboard status payload
        id: dashboard
        run: |
          python - <<'PY'
          import json
          import os
          from pathlib import Path

          payload = json.loads(Path("data/latest_dashboard.json").read_text(encoding="utf-8"))
          score = payload.get("score", "n/a")
          band = (payload.get("band") or {}).get("label", "Unknown")
          generated_at = str(payload.get("generated_at", ""))
          date_text = generated_at[:10] if len(generated_at) >= 10 else "unknown-date"
          status = "provisional" if bool(payload.get("provisional", False)) else "live"

          with Path(os.environ["GITHUB_OUTPUT"]).open("a", encoding="utf-8") as out:
              out.write(f"score={score}\n")
              out.write(f"band={band}\n")
              out.write(f"status={status}\n")
              out.write(f"date={date_text}\n")
          PY

      - name: Trigger GitLab scheduler
        if: ${{ success() }}
        env:
          GITLAB_TRIGGER_TOKEN: ${{ secrets.GITLAB_TRIGGER_TOKEN }}
          GITLAB_PROJECT_ID_OR_PATH: ${{ vars.GITLAB_PROJECT_ID_OR_PATH || 'enkieng/bluesky-scheduler' }}
          GITLAB_TRIGGER_REF: ${{ vars.GITLAB_TRIGGER_REF || 'main' }}
        run: |
          set -euo pipefail
          if [[ -z "${GITLAB_TRIGGER_TOKEN}" ]]; then
            echo "GITLAB_TRIGGER_TOKEN is not configured; skipping GitLab trigger."
            exit 0
          fi
          encoded_project="$(python - <<'PY'
          import os
          import urllib.parse

          print(urllib.parse.quote(os.environ["GITLAB_PROJECT_ID_OR_PATH"], safe=""))
          PY
          )"
          endpoint="https://gitlab.com/api/v4/projects/${encoded_project}/trigger/pipeline"
          echo "Triggering GitLab pipeline for project=${GITLAB_PROJECT_ID_OR_PATH} ref=${GITLAB_TRIGGER_REF} status=${{ steps.dashboard.outputs.status }}"
          http_code="$(curl -sS -o /tmp/gitlab-trigger-success.json -w "%{http_code}" --request POST "${endpoint}" \
            --form token="${GITLAB_TRIGGER_TOKEN}" \
            --form ref="${GITLAB_TRIGGER_REF}" \
            --form variables[DASHBOARD_URL]="${{ steps.deploy.outputs.page_url }}" \
            --form variables[DASHBOARD_STATUS]="${{ steps.dashboard.outputs.status }}" \
            --form variables[DASHBOARD_SCORE]="${{ steps.dashboard.outputs.score }}" \
            --form variables[DASHBOARD_BAND]="${{ steps.dashboard.outputs.band }}" \
            --form variables[DASHBOARD_DATE]="${{ steps.dashboard.outputs.date }}" \
            --form variables[DASHBOARD_REPOSITORY]="${{ github.repository }}" \
            --form variables[DASHBOARD_RUN_ID]="${{ github.run_id }}")"
          echo "GitLab trigger HTTP status: ${http_code}"
          cat /tmp/gitlab-trigger-success.json
          if [[ "${http_code}" != "201" ]]; then
            echo "::error::GitLab trigger failed (expected HTTP 201)."
            exit 1
          fi

      - name: Trigger GitLab scheduler (failure status)
        if: ${{ failure() }}
        env:
          GITLAB_TRIGGER_TOKEN: ${{ secrets.GITLAB_TRIGGER_TOKEN }}
          GITLAB_PROJECT_ID_OR_PATH: ${{ vars.GITLAB_PROJECT_ID_OR_PATH || 'enkieng/bluesky-scheduler' }}
          GITLAB_TRIGGER_REF: ${{ vars.GITLAB_TRIGGER_REF || 'main' }}
        run: |
          set -euo pipefail
          if [[ -z "${GITLAB_TRIGGER_TOKEN}" ]]; then
            echo "GITLAB_TRIGGER_TOKEN is not configured; skipping GitLab failure notification."
            exit 0
          fi
          encoded_project="$(python - <<'PY'
          import os
          import urllib.parse

          print(urllib.parse.quote(os.environ["GITLAB_PROJECT_ID_OR_PATH"], safe=""))
          PY
          )"
          endpoint="https://gitlab.com/api/v4/projects/${encoded_project}/trigger/pipeline"
          echo "Triggering GitLab failure notification for project=${GITLAB_PROJECT_ID_OR_PATH} ref=${GITLAB_TRIGGER_REF}"
          http_code="$(curl -sS -o /tmp/gitlab-trigger-failure.json -w "%{http_code}" --request POST "${endpoint}" \
            --form token="${GITLAB_TRIGGER_TOKEN}" \
            --form ref="${GITLAB_TRIGGER_REF}" \
            --form variables[DASHBOARD_URL]="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" \
            --form variables[DASHBOARD_STATUS]="failed" \
            --form variables[DASHBOARD_SCORE]="n/a" \
            --form variables[DASHBOARD_BAND]="Unknown" \
            --form variables[DASHBOARD_DATE]="unknown-date" \
            --form variables[DASHBOARD_REPOSITORY]="${{ github.repository }}" \
            --form variables[DASHBOARD_RUN_ID]="${{ github.run_id }}")"
          echo "GitLab failure-trigger HTTP status: ${http_code}"
          cat /tmp/gitlab-trigger-failure.json
          if [[ "${http_code}" != "201" ]]; then
            echo "::warning::GitLab failure notification trigger was not accepted."
          fi
